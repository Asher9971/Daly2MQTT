<figure class="text-center">
    <h1>Edit Configuration</h1>
</figure>
<form method="POST" action="/settingssave" enctype="multipart/form-data">
    <div class="input-group mb-3">
        <span class="input-group-text w-50" id="devicenamedesc">Device Name</span>
        <input type="text" class="form-control" aria-describedby="devicenamedesc" id="devicename" name="post_deviceName"
            maxlength="35" value="" onkeyup="this.value=this.value.replace(/\s+/g,'_');">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttserverdesc">MQTT Server</span>
        <input type="text" class="form-control" aria-describedby="mqttserverdesc" id="mqttserver" name="post_mqttServer"
            maxlength="35" value="">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttportdesc">MQTT Port</span>
        <input type="text" class="form-control" aria-describedby="mqttportdesc" id="mqttport" name="post_mqttPort"
            maxlength="5" value="">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttuserdesc">MQTT User</span>
        <input type="text" class="form-control" aria-describedby="mqttuserdesc" id="mqttuser" name="post_mqttUser"
            maxlength="35" value="">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttpassworddesc">MQTT Password</span>
        <input type="password" class="form-control" aria-describedby="mqttpassworddesc" id="mqttpassword" maxlength="35"
            name="post_mqttPassword" value="">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqtttopicdesc">MQTT Topic</span>
        <input type="text" class="form-control" aria-describedby="mqtttopicdesc" id="mqtttopic" name="post_mqttTopic"
            maxlength="35" value="" onkeyup="this.value=this.value.replace(/\s+/g,'_');">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttrefreshdesc">MQTT Refresh (sec)</span>
        <input type="text" class="form-control" aria-describedby="mqttrefreshdesc" id="mqttrefresh" maxlength="5"
            name="post_mqttRefresh" value="">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqtttriggerdesc">MQTT Data Trigger Path</span>
        <input type="text" class="form-control" aria-describedby="mqtttrigerdesc" id="mqtttrigger" maxlength="80"
            name="post_mqtttrigger" value="" onkeyup="this.value=this.value.replace(/\s+/g,'_');">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqttjsondesc">MQTT Json Style</span>
        <div class="form-switch form-control mqtt-settings-switch" style="width:50%; text-align: center;">
            <input type="checkbox" class="form-check-input form control" aria-describedby="mqttjsondesc" role="switch"
                id="mqttjson" name="post_mqttjson" value="true">
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="mqtthadisc">HA Discovery</span>
        <div class="form-switch form-control mqtt-settings-switch" style="width:50%; text-align: center;">
            <input type="checkbox" class="form-check-input form control" aria-describedby="mqtthadisc" role="switch"
                id="hadiscovery" name="post_hadiscovery" value="true" onclick='haSwitch()'>
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="webuicolormode">WebUI Dark Mode</span>
        <div class="form-switch form-control" style="width:50%; text-align: center;">
            <input type="checkbox" class="form-check-input form control" aria-describedby="webuicolormode" role="switch"
                id="webuicolormode" name="post_webuicolormode" value="true">
        </div>
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="httpUserdesc">HTTP Username</span>
        <input type="text" class="form-control" aria-describedby="httpUserdesc" id="httpUser" name="post_httpUser"
            maxlength="40" maxlength="35" value="">
    </div>
    <div class="input-group mb-2">
        <span class="input-group-text w-50" id="httpPassdesc">HTTP Password</span>
        <input type="password" class="form-control" aria-describedby="httpPassdesc" id="httpPass" name="post_httpPass"
            maxlength="40" maxlength="35" value="">
    </div>
    <div class="row gx-0 mb-2" id="esp01_settings">
        <div class="input-group mb-2">
            <span class="input-group-text w-100"><b>BMS-Wakeup Settings</b></span>
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text w-50" id="wakeupenabledesc">Enable BMS Wakeup GPIO</span>
            <div class="form-switch form-control mqtt-settings-switch" style="width:50%; text-align: center;">
                <input type="checkbox" class="form-check-input form control" aria-describedby="wakeupenabledesc"
                    role="switch" id="wakeupenable" name="post_wakeupenable" value="true">
            </div>
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text w-100"><b>Output Settings</b></span>
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text w-50" id="relaisenabledesc">Enable Output on GPIO</span>
            <div class="form-switch form-control mqtt-settings-switch" style="width:50%; text-align: center;">
                <input type="checkbox" class="form-check-input form control" aria-describedby="relaisenabledesc"
                    role="switch" id="relaisenable" name="post_relaisenable" value="true"
                    onclick='relaisSwitch()'>
            </div>
        </div>
        <div class="relaisConfig input-group mb-2">
            <span class="input-group-text w-50" id="relaisinvertdesc">Invert GPIO Output</span>
            <div class="form-switch form-control mqtt-settings-switch" style="width:50%; text-align: center;">
                <input type="checkbox" class="form-check-input form control" aria-describedby="relaisinvertdesc"
                    role="switch" id="relaisinvert" name="post_relaisinvert" value="true">
            </div>
        </div>

        <div class="relaisConfig input-group mb-2">
            <span class="input-group-text w-50" id="relaisfailsafedesc">Failsafe Mode</span>
            <div class="form-switch form-control mqtt-settings-switch" style="width:50%; text-align: center;">
                <input type="checkbox" class="form-check-input form control" aria-describedby="relaisfailsafedesc"
                    role="switch" id="relaisfailsafe" name="post_relaisfailsafe" value="true">
            </div>
        </div>

        <div class="relaisConfig input-group mb-2">
            <span class="input-group-text w-50" id="relaisfunctiondesc">Function</span>
            <select class="form-select" aria-describedby="relaisfunctiondesc" id="relaisfunction"
                name="post_relaisfunction" onclick='relaisFunc()'>
                <option value="0">Lowest Cell Voltage</option>
                <option value="1">Highest Cell Voltage</option>
                <option value="2">Pack Cell Voltage</option>
                <option value="3">Temperature</option>
                <option value="4">Manual over Web or MQTT</option>
            </select>
        </div>
        <div class="relaisConfig relaisData input-group mb-2">
            <span class="input-group-text w-50" id="relaiscomparsiondesc">Comparsion</span>
            <select class="form-select" aria-describedby="relaiscomparsiondesc" id="relaiscomparsion"
                name="post_relaiscomparsion">
                <option value="0">Higher or equal than</option>
                <option value="1">Lower or equal than</option>
            </select>
        </div>
        <div class="relaisConfig relaisData input-group mb-2">
            <span class="input-group-text w-50" id="relaissetvaluedesc">Value</span>
            <input type="number" step="0.001" class="form-control" aria-describedby="relaissetvaluedesc"
                id="relaissetvalue" name="post_relaissetvalue" value="" min="-100" max="100">
        </div>
        <div class="relaisConfig relaisData input-group mb-2">
            <span class="input-group-text w-50" id="relaishysteresisdesc">Hysteresis</span>
            <input type="number" step="0.001" class="form-control" aria-describedby="relaishysteresisdesc"
                id="relaishysteresis" name="post_relaishysteresis" value="" min="-100" max="100">
        </div>
    </div>
    <div class="d-grid gap-2">
        <input class="btn btn-primary" type="submit" value="Save settings">
        <a class="btn btn-primary" href="/settings" role="button">Back</a>
    </div>
</form>
<script>
    $(document).ready(function (load) {
        $.ajax({
            async: false,
            url: "http://"+location.host+"/sd",
            type: 'GET',
            dataType: "json",
            success: function (d) {

                $( "#devicename" ).val(d.devn);
                $( "#mqttserver" ).val(d.mqsrv);
                $( "#mqttport" ).val(d.mqprt);
                $( "#mqttuser" ).val(d.mquse);
                $( "#mqttpassword" ).val(d.mqpas);
                $( "#mqtttopic" ).val(d.mqtop);
                $( "#mqttrefresh" ).val(d.mqrfr);
                $( "#mqtttrigger" ).val(d.mqtrp);
                $( "#mqttjson" ).prop( "checked", d.mqjsn);              
                $( "#hadiscovery" ).prop( "checked", d.hadisc);
                $( "input#webuicolormode" ).prop( "checked", d.cm);
                $( "#httpUser" ).val(d.htu);
                $( "#httpPass" ).val(d.htp);
                $( "#wakeupenabledesc" ).text( "Enable BMS Wakeup GPIO "+d.wpin);
                $( "#wakeupenable" ).prop( "checked", d.wfnc);
                $( "#relaisenabledesc" ).text( "Enable Output on GPIO "+d.rpin);
                $( "#relaisenable" ).prop( "checked", d.ract);
                $( "#relaisinvert" ).prop( "checked", d.rinv);
                $( "#relaisfailsafe" ).prop( "checked", d.rflsv);
                $("#relaisfunction").val(d.rfnc);
                $("#relaiscomparsion").val(d.rcmp);
                $( "#relaissetvalue" ).val(d.rval);
                $( "#relaishysteresis" ).val(d.rhys);
            }
        });

        if(pd.if01){
                    $( "#esp01_settings" ).hide();
                }
        relaisSwitch();
        haSwitch();
        relaisFunc();
    });
    function haSwitch() {
        if (document.getElementById('hadiscovery').checked) {
            document.getElementById('mqttjson').checked = false;
            document.getElementById('mqttjson').disabled = true;
        }
        document.getElementById('mqttjson').disabled = document.getElementById('hadiscovery').checked;
    }
    function relaisSwitch() {
        var relaisRows = document.getElementsByClassName("relaisConfig");
        for (var i = 0; i < relaisRows.length; i++) {
            if (document.getElementById("relaisenable").checked) {
                relaisRows[i].style.display = '';
            } else {
                relaisRows[i].style.display = 'none';
            }
        }
    }
    function relaisFunc() {
        var relaisDR = document.getElementsByClassName("relaisData");
        for (var i = 0; i < relaisDR.length; i++) {
            if (document.getElementById("relaisfunction").value == 4 || !document.getElementById("relaisenable").checked) {
                relaisDR[i].style.display = 'none';
            } else {
                relaisDR[i].style.display = '';
            }
        }
    }
</script>